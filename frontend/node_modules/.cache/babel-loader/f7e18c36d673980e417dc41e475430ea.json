{"ast":null,"code":"import _regeneratorRuntime from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";export function newWebRTCClient(){var conn=new connHandler();conn.negotiate();}var defaultIceServers={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};var connHandler=/*#__PURE__*/function(){function connHandler(){_classCallCheck(this,connHandler);this.socket=new WebSocket(\"ws://\"+window.location.hostname+\":8050/ws\");this.peerConnection=new RTCPeerConnection(defaultIceServers);this.listener=null;}_createClass(connHandler,[{key:\"negotiate\",value:function negotiate(){var _this=this;this.peerConnection.createOffer().then(function(d){return _this.peerConnection.setLocalDescription(d);}).then(this.receiveOffer()).then(this.addUserMedia()).then(this.sendIceCandidates()).then(this.receiveIceCandidates());}},{key:\"receiveOffer\",value:function receiveOffer(){this.listener=newListener();if(this.listener().sdp){this.peerConnection.setRemoteDescription(new RTCSessionDescription(message),function(){if(this.peerConnection.remoteDescription.type==\"offer\"){this.peerConnection.createAnswer().then(function(answer){this.send(answer);return this.peerConnection.setLocalDescription(answer);}).catch(function(e){return console.log(e);});}},function(e){return console.log(e);});}}},{key:\"newListener\",value:function newListener(){return this.socket.onmessage=function(payload){var message=JSON.parse(payload.data);return message;};}},{key:\"addUserMedia\",value:function addUserMedia(){function startStream(){return _startStream.apply(this,arguments);}function _startStream(){_startStream=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return navigator.mediaDevices.getUserMedia({video:true});case 2:this.video=_context.sent;case 3:case\"end\":return _context.stop();}}},_callee,this);}));return _startStream.apply(this,arguments);}startStream();}},{key:\"sendIceCandidates\",value:function sendIceCandidates(){var _this2=this;return this.peerConnection.onicecandidate=function(event){if(isOpen(_this2.socket)&&event.candidate!=null){_this2.send(_this2.socket,event.candidate);}};}},{key:\"send\",value:function send(payload){this.socket.send(JSON.stringify(payload));}},{key:\"listen\",value:function listen(){return this.socket.onmessage=function(evt){try{var message=JSON.parse(evt.data);console.log(\"receiving: \",message);if(message.sdp){}else{this.peerConnection.addIceCandidate(message).then(console.log(\"candidate added\")).catch(function(e){return console.log(e);});}}catch(e){console.log(\"error: \",e);console.log(\"message: \");}};}}]);return connHandler;}();function isOpen(socket){return socket.readyState==WebSocket.OPEN;}","map":{"version":3,"sources":["/home/cmelgreen/GoProjects/src/ReactUserMedia/frontend/src/camera/webRTCRefactor.js"],"names":["newWebRTCClient","conn","connHandler","negotiate","defaultIceServers","iceServers","urls","socket","WebSocket","window","location","hostname","peerConnection","RTCPeerConnection","listener","createOffer","then","d","setLocalDescription","receiveOffer","addUserMedia","sendIceCandidates","receiveIceCandidates","newListener","sdp","setRemoteDescription","RTCSessionDescription","message","remoteDescription","type","createAnswer","answer","send","catch","e","console","log","onmessage","payload","JSON","parse","data","startStream","navigator","mediaDevices","getUserMedia","video","onicecandidate","event","isOpen","candidate","stringify","evt","addIceCandidate","readyState","OPEN"],"mappings":"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","sourcesContent":["export function newWebRTCClient() { \n    var conn = new connHandler()\n\n    conn.negotiate()\n}\n\nconst defaultIceServers = {\n    iceServers: [\n        {\n            urls: 'stun:stun.l.google.com:19302'\n        }\n    ]\n}\n\nclass connHandler {\n    constructor() {\n        this.socket = new WebSocket(\"ws://\" + window.location.hostname + \":8050/ws\")\n        this.peerConnection = new RTCPeerConnection(defaultIceServers)\n        this.listener = null\n    }\n\n    negotiate() {\n        this.peerConnection.createOffer()\n            .then(d => this.peerConnection.setLocalDescription(d))\n            .then(this.receiveOffer())\n            .then(this.addUserMedia())\n            .then(this.sendIceCandidates())\n            .then(this.receiveIceCandidates())\n    }\n\n    receiveOffer() {\n        this.listener = newListener()\n\n        if ( this.listener().sdp ) {\n            this.peerConnection.setRemoteDescription(new RTCSessionDescription(message), function () {\n                if (this.peerConnection.remoteDescription.type == \"offer\") {\n                    this.peerConnection.createAnswer().then(function(answer) {\n                        this.send(answer);\n                        return this.peerConnection.setLocalDescription(answer);\n                    })\n                    .catch(e => console.log(e));\n                }\n            }, e => console.log(e))\n        } \n    }\n\n    newListener() {\n        return this.socket.onmessage = function (payload) {\n            var message = JSON.parse(payload.data)\n            return message\n        }\n    }\n\n    addUserMedia() {\n        async function startStream() {\n            this.video = await navigator.mediaDevices.getUserMedia({ video: true })\n        }\n        startStream()\n    }\n\n    sendIceCandidates() {\n        return this.peerConnection.onicecandidate = event => {\n            if ( isOpen(this.socket) && event.candidate != null) {\n                this.send(this.socket, event.candidate)\n            }}\n    }\n\n    send(payload) {\n        this.socket.send(JSON.stringify(payload))\n    }\n\n\n\n    listen() {\n        return this.socket.onmessage = function (evt) {\n            try {\n                var message = JSON.parse(evt.data);\n                console.log(\"receiving: \", message)\n                if (message.sdp) {\n\n                } else {\n                    this.peerConnection.addIceCandidate(message)\n                        .then(console.log(\"candidate added\"))\n                        .catch( e => console.log(e))\n                }\n            } catch(e) {\n                console.log(\"error: \", e)\n                console.log(\"message: \", )\n            }\n        \n        }\n    }\n}\n\nfunction isOpen(socket) {\n    return (socket.readyState == WebSocket.OPEN)\n}"]},"metadata":{},"sourceType":"module"}