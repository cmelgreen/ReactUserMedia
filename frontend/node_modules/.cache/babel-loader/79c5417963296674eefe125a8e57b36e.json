{"ast":null,"code":"import _regeneratorRuntime from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _createForOfIteratorHelper from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _asyncToGenerator from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/usr/local/lib/node_modules/react-scripts/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";export function newWebRTCClient(){var conn=new connHandler();conn.negotiate();}var defaultIceServers={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};var connHandler=/*#__PURE__*/function(){function connHandler(){var _this=this;_classCallCheck(this,connHandler);this.socket=new WebSocket(\"ws://\"+window.location.hostname+\":8050/ws\");this.peerConnection=new RTCPeerConnection(defaultIceServers);this.listener=null;this.peerConnection.oniceconnectionstatechange=function(){return console.log(\"state change\",_this.peerConnection.iceConnectionState);};this.socket.addEventListener('open',function(){console.log(\"socket open\");_this.peerConnection.onnegotiationneeded=function(e){console.log(\"negotiation needed\");_this.sendOffer();};});}_createClass(connHandler,[{key:\"negotiate\",value:function negotiate(){//this.sendOffer()\nthis.startUserMedia(this);this.sendIceCandidates();this.startListener();thia.sendOffer();//.then(this.addMediaTrack())\n}},{key:\"sendOffer\",value:function sendOffer(){var _this2=this;console.log(\"sendOffer\");this.peerConnection.createOffer().then(function(d){_this2.peerConnection.setLocalDescription(d);_this2.send(d);});}},{key:\"startUserMedia\",value:function startUserMedia(conn){var f=/*#__PURE__*/function(){var _startStream=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var video,_iterator,_step,track;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:console.log(\"startUserMedia\");_context.next=3;return navigator.mediaDevices.getUserMedia({video:true});case 3:video=_context.sent;_iterator=_createForOfIteratorHelper(video.getVideoTracks());try{for(_iterator.s();!(_step=_iterator.n()).done;){track=_step.value;conn.peerConnection.addTrack(track,video);console.log(track);}}catch(err){_iterator.e(err);}finally{_iterator.f();}case 6:case\"end\":return _context.stop();}}},_callee);}));function startStream(){return _startStream.apply(this,arguments);}return startStream;}();f();}},{key:\"startListener\",value:function startListener(){console.log(\"startListener\");this.listener=this.newListener();}},{key:\"newListener\",value:function newListener(){var _this3=this;console.log(\"newListener\");var conn=this;this.socket.onmessage=function(event){var message=JSON.parse(event.data);if(message.sdp){_this3.receiveDesc(message);}else if(message.candidate){conn.receiveICECandidate(message);}};}},{key:\"receiveDesc\",value:function receiveDesc(message){console.log(\"receiveDesc\",message.type);console.log(message.sdp);this.peerConnection.setRemoteDescription(new RTCSessionDescription(message));if(message.type==\"offer\"){this.sendAnswer();}}},{key:\"sendAnswer\",value:function sendAnswer(){console.log(\"sendAnswer\");var conn=this;conn.peerConnection.createAnswer().then(function(answer){conn.send(answer);return conn.peerConnection.setLocalDescription(answer);});}},{key:\"addUserMedia\",value:function addUserMedia(){console.log(\"addUserMedia\");this.startUserMedia();}},{key:\"receiveICECandidate\",value:function receiveICECandidate(message){console.log(\"receiveICEcandidate: \",message);this.peerConnection.addIceCandidate(message);}},{key:\"sendIceCandidates\",value:function sendIceCandidates(){var _this4=this;console.log(\"sendIceCandidate\");return this.peerConnection.onicecandidate=function(event){if(_this4.isOpen()&&event.candidate!=null){_this4.send(event.candidate);}};}},{key:\"send\",value:function send(payload){console.log(\"send: \",payload);this.socket.send(JSON.stringify(payload));}},{key:\"isOpen\",value:function isOpen(){return this.socket.readyState==WebSocket.OPEN;}},{key:\"isOffer\",value:function isOffer(){return this.peerConnection.remoteDescription.type==\"offer\";}},{key:\"isAnswer\",value:function isAnswer(){return this.peerConnection.remoteDescription.type==\"answer\";}}]);return connHandler;}();","map":{"version":3,"sources":["/home/cmelgreen/GoProjects/src/ReactUserMedia/frontend/src/camera/webRTCRefactor.js"],"names":["newWebRTCClient","conn","connHandler","negotiate","defaultIceServers","iceServers","urls","socket","WebSocket","window","location","hostname","peerConnection","RTCPeerConnection","listener","oniceconnectionstatechange","console","log","iceConnectionState","addEventListener","onnegotiationneeded","e","sendOffer","startUserMedia","sendIceCandidates","startListener","thia","createOffer","then","d","setLocalDescription","send","f","navigator","mediaDevices","getUserMedia","video","getVideoTracks","track","addTrack","startStream","newListener","onmessage","event","message","JSON","parse","data","sdp","receiveDesc","candidate","receiveICECandidate","type","setRemoteDescription","RTCSessionDescription","sendAnswer","createAnswer","answer","addIceCandidate","onicecandidate","isOpen","payload","stringify","readyState","OPEN","remoteDescription"],"mappings":"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","sourcesContent":["export function newWebRTCClient() { \n    var conn = new connHandler()\n\n    conn.negotiate()\n}\n\nconst defaultIceServers = {\n    iceServers: [\n        {\n            urls: 'stun:stun.l.google.com:19302'\n        }\n    ]\n}\n\nclass connHandler {\n    constructor() {\n        this.socket = new WebSocket(\"ws://\" + window.location.hostname + \":8050/ws\")\n        this.peerConnection = new RTCPeerConnection(defaultIceServers)\n        this.listener = null\n        this.peerConnection.oniceconnectionstatechange = () => console.log(\"state change\", this.peerConnection.iceConnectionState)\n        this.socket.addEventListener('open', () => {\n            console.log(\"socket open\")\n            this.peerConnection.onnegotiationneeded = e => {\n                console.log(\"negotiation needed\")\n                this.sendOffer()\n            }\n        })\n    }\n    \n\n    negotiate() {\n        //this.sendOffer()\n        this.startUserMedia(this)\n        this.sendIceCandidates()\n        this.startListener()\n        thia.sendOffer()\n\n            //.then(this.addMediaTrack())\n    }\n\n    sendOffer() {\n        console.log(\"sendOffer\")\n        this.peerConnection.createOffer()\n            .then(d => {\n                this.peerConnection.setLocalDescription(d)\n                this.send(d)\n            })\n\n    }\n\n    startUserMedia(conn) {\n        const f = async function startStream() {\n            console.log(\"startUserMedia\")\n            var video = await navigator.mediaDevices.getUserMedia({ video: true })\n            for (const track of video.getVideoTracks()) {\n                conn.peerConnection.addTrack(track, video)\n                console.log(track)\n            }\n        }\n        f()\n    }\n\n    startListener() {\n        console.log(\"startListener\")\n        this.listener = this.newListener()\n    }\n\n    newListener() {\n        console.log(\"newListener\")\n        let conn = this\n        this.socket.onmessage = event => {\n            var message = JSON.parse(event.data)\n            if (message.sdp) {\n                this.receiveDesc(message)\n            } else if (message.candidate) {\n                conn.receiveICECandidate(message)\n            }\n        }\n    }\n\n    receiveDesc(message) {\n        console.log(\"receiveDesc\", message.type)\n        console.log(message.sdp)\n        this.peerConnection.setRemoteDescription(new RTCSessionDescription(message))\n        if (message.type == \"offer\") {\n            this.sendAnswer()\n        }\n    }\n\n    sendAnswer() {\n        console.log(\"sendAnswer\")\n        let conn = this\n        conn.peerConnection.createAnswer()\n            .then(answer => {\n                conn.send(answer)\n                return conn.peerConnection.setLocalDescription(answer)\n            })\n    }\n\n    addUserMedia() {\n        console.log(\"addUserMedia\")\n        this.startUserMedia()\n    }\n\n    receiveICECandidate(message) {\n        console.log(\"receiveICEcandidate: \", message)\n        this.peerConnection.addIceCandidate(message)\n    }\n\n    sendIceCandidates() {\n        console.log(\"sendIceCandidate\")\n        return this.peerConnection.onicecandidate = event => {\n            if ( this.isOpen() && event.candidate != null) {\n             this.send(event.candidate)\n            }}\n    }\n\n    send(payload) {\n        console.log(\"send: \", payload)\n        this.socket.send(JSON.stringify(payload))\n    }\n\n    isOpen() {\n        return ( this.socket.readyState == WebSocket.OPEN )\n    }\n    \n    isOffer() {\n        return ( this.peerConnection.remoteDescription.type == \"offer\" )\n    }\n    \n    isAnswer() {\n        return ( this.peerConnection.remoteDescription.type == \"answer\" )\n    }\n}\n\n"]},"metadata":{},"sourceType":"module"}